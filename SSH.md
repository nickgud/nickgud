| **[Putty](https://putty.org.ru/)** | **# Telnet/SSH Клиент**                                   |
|:-----------------------------------|:----------------------------------------------------------|
| **[Mobaxterm](https://mobaxterm.mobatek.net/)** | **# терминал для Windows с SSH-клиентом и сетевыми инструментами** |

---
###### SSH (Secure Shell) 
- защищенный сетевой протокол с проверкой подлинности и шифрованием. Используется для передачи файлов, управления сетью и удаленного доступа к ОС.  

SSH работает по системе "клиент-сервер".  
- На удаленном узле демон ssh прослушивает определенный сетеовой порт (по умолчанию 22) и при прохождении аутентификации создает необходимую среду для работы с ним.  
- На локальном узле устанавливается ssh-клиент. Он взаимодействует с удаленным узлом и передает ему необходимые данные.

На локальном узле создаются и хранятся открытый (*.pub) и закрытый ключ, а на удаленный узел передается только копия публичного (открытого) ключа, что позволяет подключаться к удаленному узлу с локального.
- Публичный ключ. Доступен всем. Используется для шифрования данных.
- Приватный ключ. Расшифровывает сообщения. Рекомендуется установить на него пароль для доп. защиты.  
`~/.ssh                 ` каталог для хранения ключей пользователя, доступ только владельцу.    
`~/.ssh/authorized_keys ` файл для хранения публичных ключей.   
`~/.ssh/known_hosts     ` файл для хранения публичных ключей сервера. Ключ из этого файла должен совпадать с тем, который записан в файле /etc/ssh/ssh_host_*_key.pub на сервере.  
`~/.ssh/config          ` файл параметров подключения, для каждого сервера своё (см. man ssh_config).  
 ---
###### SSH-авторизация  
- установка TCP-соединения. Обмен инфо. о версиях ssh-протоколов ( `ssh -V`  узнать версию OpenSSH).
- удаленный узел направляет клиенту открытый ключ. Если клиент доверяет этому ключу генерируется сеансовый ключ (существует только для текущей сессии), для симметричного шифрования.
- аутентификация.  
    - Клиент отсылает серверу свой открытый ключ.  
    - Сервер проверяет его со своим списком открытых ключей. Если совпадение найдено, сервер генерирует случайное число, шифрует его открытым ключом и отправляет обратно.
    - Клиент расшифровывает сообщение закрытым ключом и отправляет полученные данные серверу. Если присланное число совпадает с первоначальным то аутентификация успешна. 
---
###### Создание ssh-ключа  
По умолчанию ключи создаются в папке ~/.ssh, доступ только владельцу.  
```ssh-geygen -C "$(whoami)@$(uname -n )-$(date -I)"```  
- -C комментарий
- -p изменить старую секретную фразу на новую
- -t задать тип ключа  
- -f имя создаваемого ключа
- -v или -vv или -vvv подробный режим лог файл /var/log/auth.log
- -l просмотр криптографического отпечатка (одни на пару ключей)(длина ключа, отпечаток, комментарий, алгоритм шифрования).
---
###### Копирование открытого ключа на сервер  
- `ssh-copy-id '-p 2222 username@remote_host'` Подключение по логину и паролю. Открытый ключ автоматически копируется в файл `~/.ssh/authorized_keys`.
-  `cat ~/.ssh/id_rsa.pub | ssh username@remote_host "mkdir -p ~/.ssh && cat >> ~/.ssh/authorized_keys"`    
---
###### Настройка SSH  
- `sudo ufw allow *port*` перед сменой ssh порта открываем новый  
- `/etc/ssh/sshd_config ` смена порта; в строчке `Port` указываем свое значение
- `/etc/ssh/sshd_config ` откл. входа по паролю; в строчке `PasswordAuthentication` изменяем значение с yes на no
- `sudo service ssh restart` перезапускаем службу ssh  
---
###### Если зашифрован домашний каталог  
- `/etc/ssh/*username* `  создаем каталог вне домашнего каталога; права доступа 755, принадлежит пользователю.
- `authorized_keys     `  файл переносим в созданный каталог; права доступа 644, принадлежит пользователю.
- `/etc/ssh/sshd_config`  в этом файле добавляем запись `AuthorizedKeysFile /etc/ssh/%u/authorized_keys`  
---  
###### Проброс локального соединения на удаленную машину  
```
  ssh -L [ЛокальныйАдрес:]ЛокальныйПорт:АдресНазначения:ПортНазначения Пользователь@УдаленныйСервер
         \_____________  _____________/ \_____________  _____________/ \____________  ____________/
                       \/                             \/                            \/
                   точка входа                пункт назначения                 точка выхода
 ```  
- все локальные соединения на `точку входа` будут перебрасываться удаленному серверу (`точка выхода`), который будет соединяться с `пунктом назначения` от своего имени.  
- для OpenSSH точка входа всегда совпадает с локальным интерфейсом 127.0.0.1, поэтому его можно опустить, сразу начиная команду с порта точки входа.  
---  
###### Проброс удаленного соединения на локальную машину  
```  
ssh -R [УдаленныйАдрес:]УдаленныйПорт:АдресНазначения:ПортНазначения Пользователь@УдаленныйСервер
       \_____________  _____________/ \_____________  _____________/
                     \/                             \/                   точка выхода — хост, где
                 точка входа                    пункт назначения         выполняется эта команда
```
- для OpenSSH точка входа всегда совпадает с локальным интерфейсом 127.0.0.1, поэтому его можно опустить, сразу начиная команду с порта точки входа.  
---
###### Проброс авторизации  
Когда hidden-host доступен только с gate-host  
```
ssh -o ProxyCommand="ssh -W %h:%p user1@gate-host" user2@hidden-host
```  
```
ssh -t -A user1@gate-host 'ssh user2@hidden-host'
```  

 
  
